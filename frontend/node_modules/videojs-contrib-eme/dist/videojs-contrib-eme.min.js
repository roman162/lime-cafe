/*! @name videojs-contrib-eme @version 4.0.1 @license Apache-2.0 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("global/document"),require("video.js"),require("global/window")):"function"==typeof define&&define.amd?define(["exports","global/document","video.js","global/window"],t):t(e.videojsContribEme={},e.document,e.videojs,e.window)}(this,function(e,t,n,r){"use strict";function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}t=t&&t.hasOwnProperty("default")?t.default:t,n=n&&n.hasOwnProperty("default")?n.default:n,r=r&&r.hasOwnProperty("default")?r.default:r;var s=function(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(var n=new DataView(e),r=new DataView(t),i=0;i<n.byteLength;i++)if(n.getUint8(i)!==r.getUint8(i))return!1;return!0},a=function(e){return e instanceof Uint8Array||e instanceof Uint16Array?e.buffer:e},o=function(){var e=n.mergeOptions.apply(n,arguments);return Object.keys(e).forEach(function(t){null===e[t]&&delete e[t]}),e},c=n.xhr.httpHandler;c||(c=function(e,t){return function(n,r,i){if(n)e(n);else{if(r.statusCode>=400&&r.statusCode<=599){var s=i;return t&&(s=String.fromCharCode.apply(null,new Uint8Array(i))),void e({cause:s})}e(null,i)}}});var u=function(e,t,i,s){var a=function(e){var t=String.fromCharCode.apply(null,new Uint16Array(e)),n=(new r.DOMParser).parseFromString(t,"application/xml"),i=n.getElementsByTagName("HttpHeaders")[0],s={};if(i)for(var a=i.getElementsByTagName("name"),o=i.getElementsByTagName("value"),c=0;c<a.length;c++)s[a[c].childNodes[0].nodeValue]=o[c].childNodes[0].nodeValue;var u,d=n.getElementsByTagName("Challenge")[0];return d&&(u=r.atob(d.childNodes[0].nodeValue)),{headers:s,message:u}}(t),u=a.message,d=o(a.headers,i.emeHeaders,e.licenseHeaders);n.xhr({uri:e.url,method:"post",headers:d,body:u,responseType:"arraybuffer"},c(s,!0))},d=function(e){var t=e.initData,n=e.id,r=e.cert;"string"==typeof n&&(n=function(e){for(var t=new ArrayBuffer(2*e.length),n=new Uint16Array(t),r=0;r<e.length;r++)n[r]=e.charCodeAt(r);return n}(n));var i=0,s=new ArrayBuffer(t.byteLength+4+n.byteLength+4+r.byteLength),a=new DataView(s);new Uint8Array(s,i,t.byteLength).set(t),i+=t.byteLength,a.setUint32(i,n.byteLength,!0),i+=4;var o=new Uint16Array(s,i,n.length);return o.set(n),i+=o.byteLength,a.setUint32(i,r.byteLength,!0),i+=4,new Uint8Array(s,i,r.byteLength).set(r),new Uint8Array(s,0,s.byteLength)},y=function(e){return function(t,r){var i=o(t.emeHeaders,e.certificateHeaders);n.xhr({uri:e.certificateUri,responseType:"arraybuffer",headers:i},c(function(e,t){e?r(e):r(null,new Uint8Array(t))}))}},f=function(e,n){return r=n,(i=t.createElement("a")).href=r,i.hostname;var r,i},m=function(e){return function(t,r,i,s){var a=o({"Content-type":"application/octet-stream"},t.emeHeaders,e.licenseHeaders);n.xhr({uri:e.licenseUri,method:"POST",responseType:"arraybuffer",body:i,headers:a},c(s,!0))}},l=function(e){var t=e.video,n=e.initData,i=e.options,s=e.eventBus,a=i.keySystems["com.apple.fps.1_0"],o=a.getCertificate||y(a),c=a.getContentId||f,u=a.getLicense||m(a);return new Promise(function(e,t){o(i,function(n,r){n?t(n):e(r)})}).then(function(e){return function(e){var t=e.video,n=e.contentId,i=e.initData,s=e.cert,a=e.options,o=e.getLicense,c=e.eventBus;return new Promise(function(e,u){if(!t.webkitKeys)try{t.webkitSetMediaKeys(new r.WebKitMediaKeys("com.apple.fps.1_0"))}catch(e){return void u("Could not create MediaKeys")}var y;try{y=t.webkitKeys.createSession("video/mp4",d({id:n,initData:i,cert:s}))}catch(e){return void u("Could not create key session")}c.trigger("keysessioncreated"),y.contentId=n,y.addEventListener("webkitkeymessage",function(e){o(a,n,e.message,function(e,t){c&&c.trigger("licenserequestattempted"),e?u(e):y.update(new Uint8Array(t))})}),y.addEventListener("webkitkeyadded",function(){e()}),y.addEventListener("webkitkeyerror",function(){var e=y.error;u("KeySession error: code "+e.code+", systemCode "+e.systemCode)})})}({video:t,cert:e,initData:n,getLicense:u,options:i,contentId:c(i,(a=n,String.fromCharCode.apply(null,new Uint16Array(a.buffer||a)))),eventBus:s});var a})},g=function(e){return e.startsWith("com.apple.fps")},p=function(e){var t;return Object.keys(e).forEach(function(n){var s=function(e,t){if(t.supportedConfigurations)return t.supportedConfigurations;var n=g(e),r={},s=t.initDataTypes||(n?["sinf"]:null),a=t.audioContentType,o=t.audioRobustness,c=t.videoContentType||(n?"video/mp4":null),u=t.videoRobustness,d=t.persistentState;return(a||o)&&(r.audioCapabilities=[i({},a?{contentType:a}:{},o?{robustness:o}:{})]),(c||u)&&(r.videoCapabilities=[i({},c?{contentType:c}:{},u?{robustness:u}:{})]),d&&(r.persistentState=d),s&&(r.initDataTypes=s),[r]}(n,e[n]);t=t?t.catch(function(e){return r.navigator.requestMediaKeySystemAccess(n,s)}):r.navigator.requestMediaKeySystemAccess(n,s)}),t},v=function e(t){var r=t.mediaKeys,i=t.initDataType,s=t.initData,a=t.options,o=t.getLicense,c=t.removeSession,u=t.eventBus,d=t.contentId,y=r.createSession();return u.trigger("keysessioncreated"),new Promise(function(r,f){y.addEventListener("message",function(e){"license-request"!==e.messageType&&"license-renewal"!==e.messageType||o(a,e.message,d).then(function(e){r(y.update(e))}).catch(function(e){f(e)})},!1),y.addEventListener("keystatuseschange",function(r){var i=!1;y.keyStatuses.forEach(function(e,t){switch(u.trigger({keyId:t,status:e,target:y,type:"keystatuschange"}),e){case"expired":i=!0;break;case"internal-error":n.log.warn('Key status reported as "internal-error." Leaving the session open since we don\'t have enough details to know if this error is fatal.',r)}}),i&&y.close().then(function(){c(s),e(t)})},!1),y.generateRequest(i,s).catch(function(){f("Unable to create or initialize key session")})})},h=function(e,t){if("string"==typeof t&&(t={url:t}),!t.url&&t.licenseUri&&(t.url=t.licenseUri),!t.url&&!t.getLicense)throw new Error("Missing url/licenseUri or getLicense in "+e+" keySystem configuration.");var r=g(e);if(r&&t.certificateUri&&!t.getCertificate&&(t.getCertificate=y(t)),r&&!t.getCertificate)throw new Error("Missing getCertificate or certificateUri in "+e+" keySystem configuration.");return r&&!t.getContentId&&(t.getContentId=f),t.url&&!t.getLicense&&(t.getLicense="com.microsoft.playready"===e?function(e){return function(t,n,r){u(e,n,t,r)}}(t):r?m(t):function(e){return function(t,r,i){var s=o({"Content-type":"application/octet-stream"},t.emeHeaders,e.licenseHeaders);n.xhr({uri:e.url,method:"POST",responseType:"arraybuffer",body:r,headers:s},c(i,!0))}}(t)),t},k=function(e){var t,n=e.video,r=e.initDataType,i=e.initData,s=e.keySystemAccess,a=e.options,o=e.removeSession,c=e.eventBus,u=Promise.resolve(),d=s.keySystem;try{t=h(d,a.keySystems[d])}catch(e){return Promise.reject(e)}var y,f,m=t.getContentId?t.getContentId(a,(y=i,String.fromCharCode.apply(null,new Uint8Array(y.buffer||y)))):null;void 0===n.mediaKeysObject&&(n.mediaKeysObject=null,n.pendingSessionData=[],u=new Promise(function(e,r){n.keySystem=d,t.getCertificate?t.getCertificate(a,function(t,n){t?r(t):(f=n,e())}):e(s)}).then(function(){return s.createMediaKeys()}).then(function(e){return function(e){var t=e.video,n=e.certificate,r=e.createdMediaKeys;t.mediaKeysObject=r;var i=[];n&&i.push(r.setServerCertificate(n));for(var s=0;s<t.pendingSessionData.length;s++){var a=t.pendingSessionData[s];i.push(v({mediaKeys:t.mediaKeysObject,initDataType:a.initDataType,initData:a.initData,options:a.options,getLicense:a.getLicense,removeSession:a.removeSession,eventBus:a.eventBus,contentId:a.contentId}))}return t.pendingSessionData=[],i.push(t.setMediaKeys(r)),Promise.all(i)}({video:n,certificate:f,createdMediaKeys:e})}).catch(function(e){return e?Promise.reject(e):Promise.reject("Failed to create and initialize a MediaKeys object")}));return u.then(function(){var e=n.keySystem?function(e,t,n){return function(r,i,s){return new Promise(function(a,o){var c=function(e,t){n&&n.trigger("licenserequestattempted"),e?o(e):a(t)};g(e)?t(r,s,new Uint8Array(i),c):t(r,i,c)})}}(d,t.getLicense,c):null;return function(e){var t=e.video,n=e.initDataType,r=e.initData,i=e.options,s=e.getLicense,a=e.contentId,o={initDataType:n,initData:r,options:i,getLicense:s,removeSession:e.removeSession,eventBus:e.eventBus,contentId:a};return t.mediaKeysObject?(o.mediaKeys=t.mediaKeysObject,v(o)):(t.pendingSessionData.push(o),Promise.resolve())}({video:n,initDataType:r,initData:i,options:a,getLicense:e,contentId:m,removeSession:o,eventBus:c})})},b=function(e,t,n,r){var i=e.msKeys.createSession("video/mp4",t);if(!i)throw new Error("Could not create key session.");r.trigger("keysessioncreated"),i.addEventListener("mskeymessage",function(e){!function(e,t,n,r){var i=e.keySystems["com.microsoft.playready"];if("function"!=typeof i.getKey){"string"==typeof i?i={url:i}:"boolean"==typeof i&&(i={}),i.url||(i.url=n.destinationURL);var s=function(e,n){r&&r.trigger("licenserequestattempted"),e?r.trigger({message:"Unable to request key from url: "+i.url,target:t,type:"mskeyerror"}):t.update(new Uint8Array(n))};i.getLicense?i.getLicense(e,n.message.buffer,s):u(i,n.message.buffer,e,s)}else i.getKey(e,n.destinationURL,n.message.buffer,function(e,n){e?r.trigger({message:"Unable to get key: "+e,target:t,type:"mskeyerror"}):t.update(n)})}(n,i,e,r)}),i.addEventListener("mskeyerror",function(e){r.trigger({message:"Unexpected key error from key session with code: "+i.error.code+" and systemCode: "+i.error.systemCode,target:i,type:"mskeyerror"})}),i.addEventListener("mskeyadded",function(){r.trigger({target:i,type:"mskeyadded"})})},w=function(e,t){for(var n=0;n<e.length;n++)if(e[n].initData){var r=a(e[n].initData),i=a(t);if(s(r,i))return!0}return!1},S=function(e,t){for(var n=0;n<e.length;n++)if(e[n].initData===t)return void e.splice(n,1)},D=function(e,t,n,r){if(!t||!t.keySystems)return Promise.resolve();var i=e.initData;return p(t.keySystems).then(function(s){var a=s.keySystem;return t.keySystems[a]&&t.keySystems[a].pssh&&(i=t.keySystems[a].pssh),w(n,i)||!i?Promise.resolve():(n.push({initData:i}),k({video:e.target,initDataType:e.initDataType,initData:i,keySystemAccess:s,options:t,removeSession:S.bind(null,n),eventBus:r}))})},L=function(e,t,n){return t.keySystems&&t.keySystems["com.apple.fps.1_0"]&&e.initData?l({video:e.target,initData:e.initData,options:t,eventBus:n}):Promise.resolve()},C=function(e,t,n,i){if(t.keySystems&&t.keySystems["com.microsoft.playready"]&&!n.reduce(function(e,t){return e||t.playready},!1)){var s=e.initData;t.keySystems["com.microsoft.playready"]&&t.keySystems["com.microsoft.playready"].pssh&&(s=t.keySystems["com.microsoft.playready"].pssh),s&&(n.push({playready:!0,initData:s}),function(e){var t=e.video,n=e.initData,i=e.options,s=e.eventBus;t.msKeys&&delete t.msKeys;try{t.msSetMediaKeys(new r.MSMediaKeys("com.microsoft.playready"))}catch(e){throw new Error("Unable to create media keys for PlayReady key system. Error: "+e.message)}b(t,n,i,s)}({video:e.target,initData:s,options:t,eventBus:i}))}},K=function(e){return n.mergeOptions(e.currentSource(),e.eme.options)},_=function(e){var t=e.src();t!==e.eme.activeSrc&&(e.eme.activeSrc=t,e.eme.sessions=[])},E=function(e){return function(t){var n={code:5};"string"==typeof t?n.message=t:t&&(t.message&&(n.message=t.message),t.cause&&(t.cause.length||t.cause.byteLength)&&(n.cause=t.cause)),e.error(n)}},U=function(e){void 0===e&&(e={});var t=this,i=E(t);t.ready(function(){return function(e,t){if("video"===e.$(".vjs-tech").tagName.toLowerCase())if(_(e),r.MediaKeys)e.tech_.el_.addEventListener("encrypted",function(n){_(e),D(n,K(e),e.eme.sessions,e.tech_).catch(t)});else if(r.WebKitMediaKeys){var n=function(n){_(e),L(n,K(e),e.tech_).catch(t)};e.tech_.el_.addEventListener("webkitneedkey",function(t){var r=K(e).firstWebkitneedkeyTimeout||1e3,i=e.src();e.eme.webkitneedkey_=e.eme.webkitneedkey_||{},e.eme.webkitneedkey_.src!==i&&(e.eme.webkitneedkey_={handledFirstEvent:!1,src:i}),e.eme.webkitneedkey_.handledFirstEvent?n(t):(e.clearTimeout(e.eme.webkitneedkey_.timeout),e.eme.webkitneedkey_.timeout=e.setTimeout(function(){e.eme.webkitneedkey_.handledFirstEvent=!0,e.eme.webkitneedkey_.timeout=null,n(t)},r))})}else r.MSMediaKeys&&(e.tech_.el_.addEventListener("msneedkey",function(n){_(e);try{C(n,K(e),e.eme.sessions,e.tech_)}catch(e){t(e)}}),e.tech_.on("mskeyerror",t),e.on("dispose",function(){e.tech_.off("mskeyerror",t)}))}(t,i)}),t.eme={initializeMediaKeys:function(s,a,o){void 0===s&&(s={}),void 0===a&&(a=function(){}),void 0===o&&(o=!1);var c=n.mergeOptions(t.currentSource(),e,s),u={initDataType:"cenc",initData:null,target:t.tech_.el_};if(_(t),r.MediaKeys)D(u,c,t.eme.sessions,t.tech_).then(function(){return a()}).catch(function(e){a(e),o||i(e)});else if(r.MSMediaKeys){var d=function e(n){t.tech_.off("mskeyadded",e),t.tech_.off("mskeyerror",e),"mskeyerror"===n.type?(a(n.target.error),o||i(n.message)):a()};t.tech_.one("mskeyadded",d),t.tech_.one("mskeyerror",d);try{C(u,c,t.eme.sessions,t.tech_)}catch(e){t.tech_.off("mskeyadded",d),t.tech_.off("mskeyerror",d),a(e),o||i(e)}}},options:e}};(n.registerPlugin||n.plugin)("eme",U),e.hasSession=w,e.removeSession=S,e.handleEncryptedEvent=D,e.handleWebKitNeedKeyEvent=L,e.handleMsNeedKeyEvent=C,e.getOptions=K,e.setupSessions=_,e.emeErrorHandler=E,e.default=U,Object.defineProperty(e,"__esModule",{value:!0})});
